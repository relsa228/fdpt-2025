# General operations on Solana
**Цель:** познакомиться с базовым набором операций на сети **Solana**.
## Теоретические данные
### Общее устройство блокчейна
Представьте, что вам необходимо создать собственное приложение для электронных платежей и реализовать там базовый функционал: отслеживание балансов пользователей и переводы. Самым простым архитектурным решением будет создать базу данных на выделенном сервере и написать некоторый интерфейс для взаимодействия с ней. Пользователи смогут завести аккаунты, вы выдадите им некоторое количество валюты вашей системы для активизации переводов и все – с этого момента можно начинать заниматься экономической деятельностью.

Однако что случится, если ваш сервер перестанет функционировать? Или база данных будет скомпрометирована? Как не дать системе выйти из строя при таком сценарии. Мы столкнулись с проблемой **единой точки отказа** – наличие в системе элемента выход из строя которого сделает всю систему неработоспособной.

Одним из стандартных решений здесь будет обратиться к практикам **распределенных вычислений**. Добавим несколько новых серверов, которые будут разделены программно и физически, на них разместим реплики основной базы, которые будут использованы для восстановления данных в случае выхода из строя основной базы. Вот таким простым способом была обеспечена высокая доступность нашей, уже распределенной, системы.

Но что если сделать еще один шаг, пусть базы-реплики не просто пассивно ждут, когда в них появится необходимость, а подхватывают за основной базой все изменения и хранят актуальные слепки состояния сети в каждый момент времени. Таким образом у нас есть ведущая база, которая отвечает за изменение состояния, и базы-читатели, которые отслеживают состояние сети, но не меняют его.

Следующим логичным шагом будет раз в некоторый промежуток времени менять ведущую базу, это полезно как в целях диагностики, так и в целях повышения доступности для пользователей из разных географических локаций. То есть у нас будет механизм регулярного перехода роли ведущей базы (**лидера**) от одного узла к другому.

Выглядит так, словно мы создали простейшую блокчейн-сеть. Может быть и выглядит, однако это, естественно, не является правдой в полной мере. Для построения даже простейшего блокчейна нам необходимо решить еще несколько важных задач. Тем не менее полученная модель хорошо описывает простые принципы распределенных вычислений, на которых строится любой блокчейн.
### Алгоритмы консенсуса
В предыдущем параграфе мы остановились на идее, что смена лидера у сети может происходить не только в случае выхода из строя предыдущего лидера, но и просто с течением времени. Тогда встает два вопроса:
- Как нам определить, какая база будет лидером в каждый момент времени?
- Как быть, если данные в двух разных узлах не успели согласоваться? То есть на одном узле мы видим одно состояние, а на другом другое (в сущности не важно, что стало причиной этому, допустим задержка на сети).

В случае, когда необходимо привести систему к согласию (**консенсусу**) по какому-либо вопросу следует использовать **алгоритмы консенсуса**. Так для решения первой задачи можно применить алгоритм *выбора лидера*. Во втором же случае можно привести конфликтующие состояния сети в режим ожидания, а после принятия решения всеми участниками зафиксировать одно из них.

Все современные блокчейны на самом деле представляют собой не просто *прямую цепь* (как может показаться из названия), а *прямую цепь* на конце которой постоянно образуются десятки новых веток, которые постепенно отбрасываются через принятие коллективного решения о том, какую ветку считать главной. Именно поэтому некоторые транзакции доходят относительно быстро, а некоторые довольно медленно – не всем везет сразу попасть в ветку, которую возьмут как основную, поэтому приходится пробовать отправлять транзакции несколько раз.
#### BFT
Возвращаясь к консенсусу, одним из самых старых семейств алгоритмов консенсуса является [Paxos](https://en.wikipedia.org/wiki/Paxos_(computer_science)), предложенный Лесли Лэмпортом в 1989 году. Если вы обратите внимание на описание этого алгоритма, то увидите, что он предназначен для достижения консенсуса в сетях с ненадежными участниками. Это уточнение является крайне важным, так как узлы в сети могут сбоить, терять сообщения и т.д. Paxos решает эту проблему, однако как решить проблему злонамеренной компрометации? Ведь относительно легко достигнуть согласия в сети, где мы можем полностью доверять всем узлам, но на практике таких условий в сетях вроде блокчейна добиться невозможно. Лэмпорт сформулировал эту проблему в виде задачи о [византийских генералах](https://en.wikipedia.org/wiki/Byzantine_fault):

>Предположим, что несколько дивизий византийской армии расположились лагерем у вражеского города. Каждый из дивизий командует свой генерал. Эти генералы могут общаться друг с другом только через гонца. В ходе наблюдений за противником они должны выработать общий план действий. Однако некоторые генералы могут оказаться предателями и попытаться помешать верным генералам прийти к согласию

Данная задача положила начало развитию **BFT** (Byzantine fault-tolerance) алгоритмам консенсуса. Данные алгоритмы активно используют криптографию для аутентификации сообщений и решений. Таким образом любой участник сети может проверить подлинность сообщений через использование криптографических примитивов. Первые практические модели BFT алгоритмов были крайне медленными и неэффективными в сравнении с более классическими решениями (вроде того же Paxos), однако они развивались и сегодня BFT-подобные алгоритмы широко применяются в блокчейн сетях, хоть и зачастую в переработанном виде. Так например два самых популярных алгоритма: **Proof of stake** и **Proof of work** – являются двумя полюсами, где PoS наследует многие идеи BFT, а PoW – нет. Рассмотрим их подробнее:
- **Proof of stake** – алгоритм, выбор лидера в котором основан на доли владения участником нативной монеты сети (то есть сколько он инвестировал в сеть). Предполагается, что наличие замороженной суммы в нативном активе делает участника заинтересованным в корректной работе сети и недопущении ее компрометации. BFT предполагает, что количество участников сети известно заранее (то есть сеть не публична), PoS соответствует этому критерию (хоть и не полностью, так как число не фиксировано, а динамически меняется через стейкинг).
- **Proof of work** – алгоритм, основанный на совместной работе. Данное решение опирается на вероятностный механизм, где участникам предлагается решать криптографические задачи для включения в блокчейн списка транзакций, который предложил участник. Чем больше вычислительной мощности, тем выше шансы первым решить задачу и создать блок. Это делает порог для входа в сеть крайне низким – не нужно замораживать большие деньги, достаточно просто иметь недорогой сопроцессор для решения специфических задач (не факт, что вы что-то так заработаете, но участвовать в создании блоков сможете). Сама сеть, как следствие, становится *открытой* (участником может быть кто угодно), что противоречит классическому BFT подходу.
### Устройство сети Solana
Мы выяснили, что современные блокчейн-системы представляют собой распределённые реестры, обеспечивающие неизменяемость и согласованность данных в среде без доверенного центра. Развитие технологий консенсуса и масштабирования привело к появлению сетей нового поколения, среди которых **Solana** занимает особое место благодаря высокой пропускной способности и низкой задержке.
#### Основные понятия
Знакомство с Solana стоит начать с базовых концепций, которые используются в сети.
- **Аккаунт**: все данные в Solana хранятся в сущностях, которые называются *аккаунтами*. Если представить сеть как базу данных, то каждая запись в ней будет аккаунтом.
- **Транзакции**: для взаимодействия с сетью пользователи отправляют *транзакции*. Транзакции включают в себя некоторое множество *инструкций*, каждая из которых выполняет свою отдельную операцию. Логика выполнения операций однако хранится не в самих инструкциях (это просто вызовы), а в *программах*, которые развернуты на сети.
- **Программы**: *смарт-контракты* в сети Solana называются *программами*. Каждая программа хранится в сети на специальных аккаунтах, которые могут работать с исполняемым кодом (подробнее об этом вы узнаете в Лабораторной работе 3).
- **Монеты и токены**: отличие монеты от токена подробнее рассмотрено в Лабораторной работе 2. Пока стоит понимать, что в сети Solana есть одна нативная монета *SOL* и огромное количество разнообразных токенов. И то, и другое является ценными активами.
- **Комиссии**: сеть Solana имеет некоторое количество сборов и комиссий, которые платятся в нативной монете *SOL*. Плата со стороны сети взимается за:
	- проведение транзакций;
	- приоритизацию транзакций (если вы хотите, чтобы ваша транзакция попала в основную ветку как можно скорее);
	- плата за аренду аккаунтов – каждый аккаунт должен иметь на своем балансе некоторое количество *SOL*, чтобы продолжать существовать.
- **Блок**: набор записей о транзакциях в сети, который попадает под голосование о включении. Лидер может произвести только один блок за **слот**.
- **Слот**: период времени (*400 мс*), за который каждый лидер обрабатывает транзакции и производит **блок**.
#### Proof of History
Solana использует алгоритм консенсуса, который называется **Proof of History**. Основная проблематика, с которой работает этот алгоритм – консенсус по времени в распределенных системах. Узлы в блокчейн сетях не могут доверять внешним источникам информации о времени или любым временным меткам, которые приходят в сообщениях. Однако информация о порядке совершения событий все еще необходима для построения блоков. Архитектура алгоритма Proof of History позволяет создать историческую запись, которая бы подтверждала, что событие произошло в некоторый момент времени (или по крайней мере однозначно обозначает порядок этого события в цепочке).

В качестве примера можно привести обычную фотографию. Например, анонимный пользователь выкладывает на форум фотографию, где можно заметить газету New York Times за 27 июля 2021 года. Увидев это другие пользователи, ничего не зная про оригинального постера, могут обоснованно предположить, что фотография сделана после 27 июля 2021 года (или же что газета фальшивая).

PoH ставит своей целью предоставление подобных (разве что более надежных) временных криптографических подтверждений в сочетании с классической BFT архитектурой алгоритма PoS (PoH грубо говоря является надстройкой над ним).
#### Валидатор
Узлы сети Solana называются **валидаторами**. Валидатор – это программный комплекс, который запускается на выделенном сервере и общается с другими узлами сети по специальным протоколам (важно помнить, что для включения в глобальную сеть нужно иметь некоторый **stake**).

В число функций валидатора входит:
- проверка транзакций на корректность (подписи, баланс);
- формирование и распространение блоков;
- поддержка копии состояния сети;
- участие в механизмах консенсуса.

Уже было упомянуто, что в каждом слоте один валидатор выбирается **лидером** и отвечает за формирование блока. Остальные валидаторы выступают как **верификаторы** – они проверяют блоки лидера. Общий процесс работы можно представить следующим списком шагов:
1. Пользователь отправляет транзакцию → она попадает в сеть валидаторов.
2. Валидатор-лидер собирает транзакции в блок в рамках своего слота.
3. Он фиксирует порядок транзакций с помощью PoH.
4. Сформированный блок рассылается другим валидаторам.
5. Остальные валидаторы проверяют корректность блока (подписи, отсутствие двойных трат, выполнение программ).
6. При достижении консенсуса блок закрепляется в цепочке.

Solana предъявляет высокие требования к качеству оборудования и количеству замороженных активов в сети, чтобы стать валидатором. Этот подход с одной стороны делает сеть довольно закрытой (из-за порога вхождения), но с другой дает высокую скорость обработки транзакций, низкие комиссии и безопасность.
### Глоссарий ключевых терминов
- **Аккаунт** – базовая сущность в сети Solana, в которой хранится информация: данные пользователя, баланс или код программы.
- **Алгоритмы консенсуса** – методы достижения согласия между узлами распределённой системы о текущем состоянии данных.
- **База-реплика** – копия базы данных, которая синхронизируется с основной и используется для повышения отказоустойчивости.
- **Блок** – набор транзакций, сформированный лидером за один слот и предложенный к включению в цепочку.
- **Блокчейн** – распределённый реестр, где данные объединяются в последовательную цепочку блоков и защищены от изменения.
- **Валидатор** – узел в сети Solana, который проверяет транзакции, формирует блоки и участвует в механизме консенсуса.
- **Верификатор** – валидатор, проверяющий корректность блока, созданного лидером.
- **Задача о византийских генералах** – классическая задача о согласовании действий в условиях ненадёжных и потенциально злонамеренных участников.
- **Высокая доступность** – свойство системы продолжать работу даже при выходе из строя отдельных её компонентов.
- **Единая точка отказа** – компонент системы, отказ которого приводит к полной остановке всей системы.
- **Лидер** – валидатор, выбранный на один слот для формирования блока.
- **Программа** – смарт-контракт в Solana, исполняемый код, развернутый в сети.
- **Распределённые вычисления** – подход, при котором задачи выполняются на множестве узлов, взаимодействующих по сети.
- **Слот** – минимальный временной интервал в Solana (≈400 мс), в течение которого лидер может сформировать один блок.
- **Транзакция** – сообщение пользователя, которое содержит инструкции для выполнения в сети.
- **Форк** – ситуация, когда сеть временно разделяется на несколько веток блоков; разрешается алгоритмами консенсуса.
- **Комиссия** – плата, взимаемая в сети Solana в нативной монете SOL за транзакции, хранение аккаунтов и приоритет обработки.
- **Монета** – нативный актив блокчейн-сети (в Solana это SOL), необходимый для оплаты комиссий и работы сети.
- **Токен** – цифровой актив, созданный поверх блокчейн-сети; может представлять любую ценность (от валюты до игровых предметов).
- **Proof of History (PoH)** – алгоритм консенсуса в Solana, который фиксирует порядок транзакций без необходимости доверять внешним источникам времени.
- **Proof of Stake (PoS)** – алгоритм консенсуса, в котором вероятность стать лидером зависит от доли монет, находящихся в стейкинге у участника.
- **Proof of Work (PoW)** – алгоритм консенсуса, основанный на решении вычислительно сложных задач; чем больше мощности у узла, тем выше шанс создать блок.
### References
1. Wong, D. (2021). Real-world cryptography. Manning Publications.
2. [Solana: A new architecture for a high performance blockchain](https://solana.com/solana-whitepaper.pdf)
3. [From Bitcoin to Solana – Innovating Blockchain towards Enterprise Applications](https://arxiv.org/pdf/2207.05240)
4. [SoK: Consensus in the Age of Blockchains](https://arxiv.org/pdf/1711.03936)
5. [Understanding blockchain: definitions, architecture, design, and system comparison](https://arxiv.org/pdf/2207.02264)
6. [The Security Reference Architecture for Blockchains: Towards a Standardized Model for Studying Vulnerabilities, Threats, and Defenses](https://arxiv.org/pdf/1910.09775)
7. [Proof of History – A clock for blockchain](https://solana.com/news/proof-of-history---a-clock-for-blockchain)
8. [Proof of History, Proof of Stake, Proof of Work - Explained](https://www.helius.dev/blog/proof-of-history-proof-of-stake-proof-of-work-explained)
9. [Consensus on Solana](https://www.helius.dev/blog/consensus-on-solana)
10. [Understanding Slots, Blocks, and Epochs on Solana](https://www.helius.dev/blog/solana-slots-blocks-and-epochs)

## Задание
- **Развернуть локальный валидатор:**
	- используйте [Solana CLI](https://solana.com/docs/intro/installation) (пока не обращайте внимание на **Anchor CLI**);
	- создайте локальный кошелек;
	- сделайте айрдроп;
	- сделайте перевод;
	- посмотрите на результат через [solscan](https://solscan.io/) или [solana explorer](https://explorer.solana.com/) (оба обозревателя поддерживают работу с локальными валидаторами).
- **Создайте набор скриптов с помощью SDK:**
	- *Скрипт 1.* Создает новый кошелек;
	- *Скрипт 2.* Вызывает айрдроп на указанный адрес;
	- *Скрипт 3.* Трансфер указанного количества лампортов между адресами;
	- *Скрипт 4.* Перевод всех доступных лампортов с рабочего адреса на указанный адрес.
- **Протестируйте скрипты:**
	- на локальном валидаторе;
	- на глобальном Solana Devnet.
## Definition of done
- Поднят локальный валидатор.
- Готов набор скриптов.
- Освоены теоретические данные по работе в сети Solana.
