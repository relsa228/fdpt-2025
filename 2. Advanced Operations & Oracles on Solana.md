# Advanced Operations & Oracles on Solana
**Цель:** познакомиться с более сложными концепциями Web3 на Solana.
## Теоретические данные
### Coins & tokens
Одной из ключевых концепций в сети Solana является деление **активов** на **монеты** (*coins*) и **токены** (*tokens*). В обоих случаях речь идет о носителях некоторой ценности; они обладают стоимостью, подходят для обмена (в силу первой причины) и свободно обращаются внутри сети, используя ее инфраструктуру.

Разница состоит в том, что **монета** выполняет роль системного элемента сети и может быть представлена только одним активом (в данном случае это *SOL*). Они выпускаются самой сетью, используются для оплаты комиссий, выплат вознаграждений валидаторам, стейкинга и обеспечения консенсуса. Кроме того, SOL служит универсальной единицей стоимости для выражения цены любых других активов в сети.

**Токены** же представляют собой инструмент закрепления прав владения чем-либо за некоторым аккаунтом. Эмитентом токена может быть любой пользователь, который имеет достаточно монет для обслуживания аккаунта своего токена и его выпуска. Токенизация в целом обеспечивает однозначное цифровое подтверждение права собственности или иной ценности.

Проводя аналогии из мира классических финансов, с монетами можно соотнести обычные *фиатные* деньги. Их выпускает некоторый формальный *институт*, которому были предоставлены полномочия эмиссии денежных средств в конкретной юрисдикции. Деньги сами по себе, опять же в рамках определенной юрисдикции, являются мерой стоимости, они не несут в себе иной функции, кроме создания условий для проведения финансовых операций (в рамках аналогии мы представляем, что валюта государства на его территории является безальтернативным инструментом выражения стоимости).

Токены же можно сравнить с акциями публичных компаний. Их выпускает частное лицо (а не формальный институт), они, в классическом виде, закрепляют за покупателем право владения долей в компании. Они как правило обладают большей волатильностью, чем фиатные деньги, что делает их хорошим инструментом для спекулятивного заработка.

Разумеется, данная аналогия не может в полной мере описать всех аспектов и тонкостей самого понятия *актива* в децентрализованной экономике (это и другие понятия вообще довольно тяжело объяснить на языке стандартных (централизованных) финансов), однако она дает корректное начальное представление об отличии монеты от токена.
### SPL Token
Говоря о токенах был упомянут тот факт, что его эмитентом может быть любой пользователь. Для упрощения процесса выпуска пользовательских токенов был создан специальный стандарт – **SPL Token (Solana Program Library Token)**.

Логику всех инструкций по работе с токенами содержит в себе системная программа **Token Program** (на данный момент их две).

В сущности, токены в сети Solana делятся на два вида:
- **взаимозаменяемые:** каждая выпущенная единица токена идентична любой другой (в качестве примера можно взять **USDC** (стабильный) или **DOGE** (волатильный))
- **невзаимозаменяемые:** выпускается только одна уникальная единица токена, выпуск других таких единиц технически больше невозможен (**NFT**)
*Token programs* содержат в себе инструкции для работы с обоими видами токенов.

Выпуск SPL токена всегда сопряжен с созданием нескольких аккаунтов в сети:
- **Mint account**: хранит в себе метаданные токена (общая сумма эмиссии, *mint authority* (эмитент) и другое).
- **Token Account**: связывает между собой конкретного владельца с конкретным **Mint account**. То есть это отдельный кошелек для токена, который связан с кошельком *SOL* некоторого пользователя.
- **Associated Token Accounts**: создан для упрощения процесса поиска адреса **Token Account** для конкретного пользователя.

Таким образом, SPL Token обеспечивает унифицированный и безопасный способ взаимодействия пользователей с пользовательскими активами.
### DeFi
В первом пункте уже было поверхностно затронуто противоречие между централизованными и децентрализованными финансами. Сильно углубляться в эту проблематику пока не стоит, рассмотрим только одну из ее частей – *доверие*.

В традиционной финансовой системе человек зачастую взаимодействует с крупными институтами (банки, биржи, фонды и т.д.), и весь процесс этого взаимодействия строится на том, что человек институту доверяет. Относя деньги в банк, мы рассчитываем, что сможем вернуть их обратно в любой момент; делая вклад, предполагается, что банк не обанкротится и сможет выплачивать дивиденды вкладчикам; работая с биржей хочется верить, что торговый аккаунт не будет заморожен вместе со всеми активами посреди сделки, а сами сделки будут честными. Этот вариант вполне рабочий, когда имеется правовое поле и высший авторитет в лице надзорных органов, которые не дадут финансовым институтам пренебрегать интересами своих партнеров.

Однако, что делать, если такого авторитета нет, следовательно невозможно доверять своему контрагенту? Децентрализованные финансы решают это с помощью **смарт-контрактов**. Они называются *контрактами* именно потому что описывают условия некоторой сделки, при этом вступив в сделку у контрагентов нет возможности отступить от нее, иначе, чем это предусмотрено самим смарт-контрактом. Иными словами, здесь нет необходимости доверять партнеру, все решается прозрачной логикой программного кода, с которым можно ознакомиться перед вступлением в сделку.

Это решение позволяет реализовать децентрализованные варианты для любых услуг из традиционных финансов. От страхования до кредитования – что угодно.

В качестве примера можно рассмотреть децентрализованные обменные сервисы – **DEX**. В отличии от обменов на централизованной бирже (напрямую через p2p или через открытие ордеров на покупку/продажу), DEX реализуют логику обмена через смарт-контракты и пулы ликвидности. Первый элемент отвечает за логику обмена и расчет цены (существуют разные [алгоритмы формирования цен](https://rocknblock.io/blog/market-making-models-in-dex-development-you-should-know)), второй элемент является хранилищем активов, которые используются при обмене. Эта довольно простая **DeFi** модель в итоге оказалась крайне востребованной и получила свое развитие, теперь она является хорошим примером внедрения децентрализованных финансовых сервисов.
### Oracles
Несмотря на широкие возможности смарт-контрактов, блокчейн имеет важное ограничение: он не обладает встроенным доступом к *данным из внешнего мира*. Без этого затруднена интеграция децентрализованных инструментов в реальную экономику. При заключении обычного контракта такой проблемы нет, так как контрагенты сами по себе являются источниками таких данных, более того, как правило существуют арбитры, которые могу разрешить конфликты, в случае их возникновения.

В блокчейн сетях эта проблема решается **оракулами** – сервисы, которые предоставляют децентрализованный способ получения данных из внеблокчейн-среды, в их числе:
- погода;
- рыночные котировки;
- результаты спортивных/политических/каких-либо других событий.

Существуют разные способы доставки внешней информации в блокчейн, однако в общем случае это выглядит так:
- данные собираются **вне сети**;
- **публикация** в сети происходит через **транзакцию** с записью в аккаунт;
- **программы** (смарт-контракты) могут читать эти данные из аккаунтов и использовать их в своей логике.

Централизованность оракулов делает их крайне опасным вектором атаки на контракты, которые их используют. Для решения проблемы с безопасностью было предложено несколько архитектурных решений:
- **Централизованные оракулы**: простые, одиночные оракулы, публикующие данные в сети. Имеют единый источник информации, поэтому ничего не мешает им давать ложные сведения.
- **Консенсусные сети**: сеть из нескольких оракулов, имеющих собственные источники данных. Окончательный ответ сети оракулов зависит от общего консенсуса внутри ее. Данное решение более безопасно, однако все еще оставляет широкие возможности для злоумышленников влиять на консенсус через вброс ложных сведений.
- **PoS сети**: в этой модели оракулы должны заблокировать некоторое количество монет для участия. В случае подачи ложных данных (ответ оракула слишком сильно отличается от консенсуса сети), монеты отчуждаются в пользу протокола, злоумышленник же более не сможет участвовать в процессе принятия решений (до внесения нового залога).
### Глоссарий ключевых терминов
- **Coin (монета)** – системный актив блокчейна, выпускаемый самой сетью (в Solana – **SOL**). Используется для оплаты комиссий, вознаграждения валидаторов, стейкинга и выражения стоимости других активов.
- **Token (токен)** – цифровой актив, выпускаемый пользователями сети. Может закреплять права собственности или иные ценности. Делится на взаимозаменяемые (fungible) и невзаимозаменяемые (non-fungible, NFT).
- **SPL Token** – стандарт выпуска токенов в сети Solana. Определяет правила создания и использования пользовательских активов через программу **Token Program**.
- **Mint account** – аккаунт, описывающий конкретный токен (метаданные, эмиссия, полномочия эмитента).
- **Token account** – кошелек пользователя для хранения конкретного токена.
- **Associated Token Account (ATA)** – вспомогательный аккаунт, автоматически создаваемый для упрощения работы с токенами.
- **DeFi (Decentralized Finance)** – децентрализованные финансовые сервисы, работающие без посредников. Функции традиционных институтов (банков, бирж) выполняют смарт-контракты.
- **DEX (Decentralized Exchange)** – децентрализованная биржа. Осуществляет обмен активов с помощью смарт-контрактов и пулов ликвидности (часто на основе алгоритма **AMM**).
- **Oracle (оракул)** – сервис, передающий в блокчейн данные из внешнего мира (цены, события, показатели). Может быть централизованным или децентрализованным; надежность DeFi-протоколов зависит от его архитектуры.
### References
1. [Glossary term](https://www.solflare.com/glossary/token-coin/)
2. [Crypto Coins vs. Tokens: What’s the Real Difference?](https://coincub.com/coins-vs-tokens/)
3. [Tokens on Solana](https://solana.com/docs/tokens)
4. [Solana Dev 101 - Mint SPL Tokens on Solana](https://www.helius.dev/blog/working-with-solana-tokens)
5. [CeFi vs. DeFi – Comparing Centralized to Decentralized Finance](https://arxiv.org/pdf/2106.08157)
6. [A Short Survey on Business Models of Decentralized Finance (DeFi) Protocols](https://www.researchgate.net/publication/358658258_A_Short_Survey_on_Business_Models_of_Decentralized_Finance_DeFi_Protocols)
7. [What is a DEX?](https://www.coinbase.com/learn/crypto-basics/what-is-a-dex)
8. [Oracles and Oracle Networks](https://solana.com/developers/courses/connecting-to-offchain-data/oracles)
## Задание
- **Работа с Solana Program Library (SPL):**
	- создайте токен (получите **mint-аккаунт**);
	- добавьте метаданные (изображение, описание и т.д.);
	- выпустите некоторое количество токена (используйте **SPL Associated Token Accounts**);
	- сделайте *airdrop* вашего токена на несколько аккаунтов.
- **Интегрируйте ваш токен в DEX:**
	- Для работы **DEX** как правило используют *WSOL*, а не *SOL*. Для того чтобы получить немного *WSOL* в *devnet* надо сначала запросить airdrop *SOL* на свой devnet аккаунт с помощью [Solana devnet faucet](https://faucet.solana.com/), а после этого конвертировать SOL в WSOL с помощью этого [скрипта](https://github.com/relsa228/fdpt-2025/blob/main/additional-info/scripts/wsol.ts) (если хотите, можете написать свой скрипт или использовать CLI).
	- Создайте пул с парой *ВАШ_ТОКЕН/WSOL* на любом **DEX** в *devnet* (например в Raydium).
    - выполнение *swap* на пуле с вашим токеном через готовую библиотеку/SDK.
    - *Дополнительная информация:* если вы выполняете задание с помощью Raydium SDK, обратите внимание на [примеры](https://github.com/raydium-io/raydium-sdk-V2-demo/tree/master/src/amm). Как правило такие примеры есть для любой SDK, не пренебрегайте ими.
- **Знакомство с оракулами:**
    - получение цены активов (*SOL*, *BTC*, *ETH*) из *Pyth oracle*;
    - узнайте цену текущую цену вашего токена в *USDC*. Для этого посмотрите на вашем пуле, сколько стоит токен относительно *WSOL*, потом посмотрите сколько стоит *WSOL* относительно *USDC*. Либо можете создать новый пул *ВАШ_ТОКЕН/USDC* (у USDC есть свой [faucet](https://spl-token-faucet.com/?token-name=USDC-Dev)) и смотреть цену относительно его. Приняты будут оба варианта.
    - имея цену в *USDC* (цена этого токена напрямую привязана к *USD*) предскажите цену вашего токена относительно активов не из сети *Solana* (через конвертацию в *USD*).
## Definition of done
- Создан токен.
- Проведен *swap* через DEX.
- Получена цена токена в монетах не из сети Solana.
